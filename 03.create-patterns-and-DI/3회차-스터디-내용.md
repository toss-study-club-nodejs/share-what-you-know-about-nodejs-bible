# 3회차 스터디 내용

## DI 가 테스트를 편하게 해주는가?
테스트 대상의 내부 구현이 외부 환경에 종속을 갖는 상황이라면

테스트 작성시 내부 구현에 따라 외부 환경을 세팅해줘야한다. 

이런 상황에서 DI 를 이용하면 외부 환경 세팅 대신 모킹을 통해 외부환경을 원하는데로 세팅해줄 수 있다.

하지만 모킹 해줄 대상이 많아지거나 모킹 구현이 어렵다면 테스트 하고자 하는 함수를 분리하여 테스트 하는 방법도 있다.

## 목킹은 언제 해야되는가?
- 디비, 레디스와 같은 인프라에 의존하는 경우
- 타 서버의 api 와 같이 테스트 환경에서 제어할수 없는 외부 환경

## 클래스를 싱글톤으로 사용하게 강제하는 방법 3가지
1. 생성자를 private 으로 선언하고 인스턴스 생성 방식을 특정 함수로 강제한다.
2. 싱글톤 생성 로직마저 공통화 하고 싶다면? [singleton-decorator-block-new.ts](%ED%95%9C%EC%98%88%EC%84%B1%2Fsrc%2Fsingleton-decorator-block-new.ts)
3. 데코레이터 방식으로 처리하는 방법 [singleton-decorator-with-closure.ts](%ED%95%9C%EC%98%88%EC%84%B1%2Fsrc%2Fsingleton-decorator-with-closure.ts)

## 싱글톤 패턴을 사용할때 주의할점
- 모듈시스템에서는 싱글톤이 보장되지 않는다. e.g) 같은 패키지의 서로 다른 버전을 참조하는 경우
  - 같은 클래스같지만 다른 node_modules 에서 가져오면 의도한대로 싱글톤 생성이 안될수도 있음
    ```
    a => b(1.1) =>
      => c => b(1.2)
    ```

## DI로 주입된 인스턴스를 신뢰할 수 있을까?
- TS에서는 덕타이핑 허용하기 때문에 무조건 적으로 신뢰할 수 없다.
  - (누군가의 실화) insert 타입의 클래스만 받아야하는데 update 하는 클래스가 insert 하는 타입의 클래스와 구조적으로 동일하여 타입 에러가 발생하지 않았음

## nestjs 에서 인스턴스 라이브사이클을 결정하는 기준
provider 로 선언하면 기본적으로 싱글톤으로 관리된다. 

하지만 상황에 따라서 request 단위로 인스턴스를 관리해야되는 케이스가 있다.

이 때 요청 단위로 인스턴스를 생성할수 있도록 request scope 라는걸 nest 에서 제공한다.

요청에 따라 인스턴스의 내부 상태가 매번 초기화 되어야하는 케이스가 아니라면 싱글톤으로 관리하는게 좋다.

e.g)

아래 두 케이스 모두 전략 패턴을 기반으로 작성되어있을때
- 인스턴스의 내부 상태에 요청 시간이 초기화 값으로 세팅되어야하는 경우는 request scope 로 관리하는게 좋다.
- 요청의 param 값에 따라 구현 클래스가 달라졌을때는 미리 싱글톤으로 생성된 인스턴스를 조회해서 가져오는 방향으로   

## 공개 생성자 패턴의 적용
Promise 인스턴스를 생성하는 방법이 공개 생성자 패턴이며

이 패턴을 사용해보니 인스턴스의 내부 구현을 캡슐화하기 좋았다

[Google.ts](sungjun.kim%2Fsrc%2FGoogle.ts) 의 생성 로직을 참고

## 생성자 패턴이 필요한 이유
1. DX 를 위해서 
  - 객체간의 관계를 인터페이스로 표현할때 해당 객체의 생성자 코드를 보고 실제 어떤 구현체를 넣어줘야하는지 알기 힘든 케이스가 있다. 이때 상황에 맞는 factory, builder 를 만들어서 제공하면 사용하는 개발자 입장에서 더 쉽게 객체간의 관계를 파악할수 있고, 사용하기도 쉬워진다.
2. 생성 로직에 비지니스 로직을 적용하기 편하다.
  - [sample.service.test.ts](%EB%B0%95%EC%A0%95%EC%9B%85%2F__test__%2F1%2Fsample.service.test.ts) 의 두번째 테스트 코드를 참고 

## 테스트 관련 아티클 ( by 민우님 )
- [인프랩CTO인 동욱님의 블로그](https://jojoldu.tistory.com/category/%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%BD%94%EB%93%9C)
- [민우님의 포스팅](https://tech.inflab.com/20230404-test-code/)

